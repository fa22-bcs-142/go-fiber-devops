name: Complete CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches:  [main]

env:
  GO_VERSION: '1.21'
  DOCKER_IMAGE:  nehaghauri/go-fiber-app
  AWS_REGION: us-east-1

jobs:
  # Stage 1: Build & Test
  test:
    name: Build and Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name:  Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: Run tests
        run: go test -v ./...
      
      - name: Run linter
        run: |
          go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
          golangci-lint run

  # Stage 2: Security/Linting
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v3
      
      - name: Run Trivy vulnerability scanner
        uses:  aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

  # Stage 3: Docker Build and Push
  build: 
    name: Docker Build and Push
    needs: security
    runs-on:  ubuntu-latest
    steps: 
      - uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets. DOCKER_PASSWORD }}
      
      - name: Build and push
        uses: docker/build-push-action@v4
        with: 
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
            ${{ env.DOCKER_IMAGE }}:latest

  # Stage 4: Terraform Apply
  terraform:
    name:  Terraform Infrastructure
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets. AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
      
      - name: Terraform Init
        working-directory: infra/terraform
        run: terraform init
      
      - name: Terraform Plan
        working-directory: infra/terraform
        run: terraform plan -out=tfplan
      
      - name: Terraform Apply
        working-directory: infra/terraform
        run: terraform apply -auto-approve tfplan

  # Stage 5: Ansible Configuration
  ansible:
    name:  Ansible Configuration
    needs: terraform
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3
      
      - name: Install Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible
      
      - name: Run Ansible Playbook
        working-directory: infra/ansible
        run: |
          ansible-playbook -i inventory/hosts.yml \
            playbooks/setup-infrastructure.yml

  # Stage 6: Kubernetes Deployment
  deploy:
    name: Kubernetes Deployment
    needs: ansible
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses:  actions/checkout@v3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --name go-fiber-cluster --region ${{ env.AWS_REGION }}
      
      - name: Deploy to Kubernetes
        run: |
          kubectl apply -k k8s/overlays/prod/
          kubectl rollout status deployment/prod-go-fiber-app -n go-fiber-prod
      
      - name: Deploy Monitoring
        run: |
          kubectl apply -f monitoring/prometheus/
          kubectl apply -f monitoring/grafana/

  # Stage 7: Post-Deploy Smoke Tests
  smoke-test:
    name: Smoke Tests
    needs: deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps: 
      - uses: actions/checkout@v3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id:  ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:  ${{ env.AWS_REGION }}
      
      - name:  Get Service Endpoint
        run: |
          kubectl get svc -n go-fiber-prod
          ENDPOINT=$(kubectl get svc prod-go-fiber-app -n go-fiber-prod -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
          echo "ENDPOINT=$ENDPOINT" >> $GITHUB_ENV
      
      - name: Health Check
        run: |
          sleep 30
          curl -f http://${ENDPOINT}/v1/health-check || exit 1